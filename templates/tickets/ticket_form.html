{% extends "layout.html" %}
{% block title %}Novo Chamado · Sollus{% endblock %}
{% block content %}

<div class="row g-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0"><i class="fa-solid fa-plus-circle me-2"></i>Novo Chamado</h5>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('tickets.dashboard') }}"><i class="bi bi-arrow-left"></i> Voltar</a>
      </div>
      <div class="card-body">
        {% if form.errors %}
          <div class="alert alert-warning">
            <strong>Verifique os campos:</strong>
            <ul class="mb-0">
              {% for field, errs in form.errors.items() %}
                {% for e in errs %}<li><code>{{ field }}</code>: {{ e }}</li>{% endfor %}
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <form id="formNovoChamado" action="{{ url_for('tickets.create_ticket') }}" method="POST" enctype="multipart/form-data" novalidate>
          {{ form.csrf_token }}

          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <label class="form-label">Título</label>
              {{ form.title(class="form-control", placeholder="Ex.: Erro ao acessar relatórios") }}
            </div>
            <div class="col-6 col-lg-2">
              <label class="form-label">Prioridade</label>
              {{ form.priority(class="form-select") }}
            </div>
            <div class="col-6 col-lg-2">
              <label class="form-label">Atendente</label>
              <select name="assignee_id" class="form-select">
                <option value="">— Selecionar —</option>
                {% for u in agents %}
                  <option value="{{ u.id }}">{{ u.name or u.username or u.email }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Descrição</label>
              {{ form.description(class="form-control", rows="6", placeholder="Explique o que aconteceu, passos para reproduzir e impacto") }}
              <div class="form-text"><span id="descCount">0</span> caracteres</div>
            </div>

            <div class="col-12">
              <label class="form-label">Anexos (opcional)</label>
              <input id="attachmentsInput" name="attachments" type="file" class="form-control" multiple
                     accept=".png,.jpg,.jpeg,.gif,.pdf,.txt,.log,.csv,.doc,.docx,.xls,.xlsx">
              <div class="form-text">Arquivos permitidos: imagens, PDF, documentos, logs (até 20MB por arquivo).</div>

              <!-- Pré-visualização simples -->
              <div id="preview" class="row g-2 mt-2"></div>
            </div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-primary" type="submit"><i class="bi bi-check2-circle"></i> Criar Chamado</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('tickets.dashboard') }}">Cancelar</a>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    // contador de caracteres
    const desc = document.getElementById("{{ form.description.id }}");
    const count = document.getElementById("descCount");
    if (desc && count){
      const upd = ()=> count.textContent = (desc.value||'').length;
      desc.addEventListener('input', upd); upd();
    }

    // preview de imagens selecionadas
    const input = document.getElementById('attachmentsInput');
    const preview = document.getElementById('preview');
    const imgExt = new Set(['.png','.jpg','.jpeg','.gif','.webp']);
    function ext(name){ const i=name.lastIndexOf('.'); return i>=0?name.slice(i).toLowerCase():''; }
    input?.addEventListener('change', () => {
      preview.innerHTML = '';
      const files = Array.from(input.files||[]);
      files.forEach(f=>{
        const e = ext(f.name);
        if (!imgExt.has(e)) return; // só mostra preview de imagens
        const col = document.createElement('div'); col.className = 'col-6 col-md-3 col-lg-2';
        const img = document.createElement('img'); img.className = 'img-fluid rounded border';
        img.alt = f.name;
        col.appendChild(img); preview.appendChild(col);
        const r = new FileReader();
        r.onload = ev => img.src = ev.target.result;
        r.readAsDataURL(f);
      });
    });
  })();
</script>
{% endblock %}
